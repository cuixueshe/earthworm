<template>
  <div class="text-center pt-2">
    <div class="flex relative flex-wrap justify-center gap-2 transition-all">
      <template
        v-for="(w, i) in courseStore.words"
        :key="i"
      >
        <div
          class="h-[4.8rem] border-solid rounded-[2px] border-b-2 text-[3.2em] transition-all"
          :class="getWordsClassNames(i)"
          :style="{ minWidth: `${inputWidth(w)}ch` }"
        >
          {{ userInputWords[i]["userInput"] }}
        </div>
      </template>
      <input
        ref="inputEl"
        class="absolute h-full w-full opacity-0"
        type="text"
        v-model="inputValue"
        @keydown="handleKeydown"
        @focus="handleInputFocus"
        @blur="handleBlur"
        @dblclick.prevent
        @mousedown="preventCursorMove"
        autoFocus
      />
    </div>
    <div class="mt-12 text-xl dark:text-gray-50">
      {{
        courseStore.currentStatement?.chinese || "生存还是毁灭，这是一个问题"
      }}
    </div>
  </div>
</template>

<script setup lang="ts">
import { onMounted, ref, watch } from "vue";
import { useAnswerTip } from "~/composables/main/answerTip";
import { useGameMode } from "~/composables/main/game";
import { useInput } from "~/composables/main/question";
import { useKeyboardSound } from "~/composables/user/sound";
import { useSpaceSubmitAnswer } from "~/composables/user/submitKey";
import { useShowWordsWidth } from "~/composables/user/words";
import { useCourseStore } from "~/store/course";
import { usePlayTipSound, useTypingSound } from "./useTypingSound";

const courseStore = useCourseStore();
const inputEl = ref<HTMLInputElement>();
const { setInputCursorPosition, getInputCursorPosition, preventCursorMove } =
  useCursor();
const { focusing, handleInputFocus, handleBlur } = useFocus();
const { showAnswer } = useGameMode();
const { isShowWordsWidth } = useShowWordsWidth();
const { isUseSpaceSubmitAnswer } = useSpaceSubmitAnswer();
const { isKeyboardSoundEnabled } = useKeyboardSound();
const { checkPlayTypingSound, playTypingSound } = useTypingSound();
const { playRightSound, playErrorSound } = usePlayTipSound();

const {
  inputValue,
  userInputWords,
  submitAnswer,
  setInputValue,
  handleKeyboardInput,
  isFixMode,
} = useInput({
  source: () => courseStore.currentStatement?.english!,
  setInputCursorPosition,
  getInputCursorPosition,
  inputChangedCallback,
});
const { showAnswerTip, hiddenAnswerTip } = useAnswerTip();

watch(
  () => inputValue.value,
  (val) => {
    setInputValue(val);
  }
);

function getWordsClassNames(index: number) {
  const word = userInputWords[index];
  // 当前单词激活 且 聚焦
  if (word.isActive && focusing.value) {
    return "text-fuchsia-500 border-b-fuchsia-500";
  }

  // 当前单词错误 且 聚焦
  if (word.incorrect && focusing.value) {
    // Fix 修复模式添加动画
    return `text-red-500 border-b-red-500 ${isFixMode() && "animate-shake"}`;
  }

  // 默认样式
  return "text-[#20202099] border-b-gray-300 dark:text-gray-300 dark:border-b-gray-400";
}

function inputChangedCallback(e: KeyboardEvent) {
  if (isKeyboardSoundEnabled() && checkPlayTypingSound(e)) {
    playTypingSound();
  }
}

// 输入宽度
function inputWidth(word: string) {
  if (!isShowWordsWidth()) {
    // 不显示对应单词宽度，默认 4 字符宽度
    return 4;
  }

  // 单词宽度
  let width = 0;

  // 单词转小写字符数组
  word = word.toLocaleLowerCase();
  const wordArr = word.split("");

  // 字符宽度1.1的字符数组
  const onePointOneLetters = ["u", "o", "p", "q", "n", "h", "g", "d", "b"];

  // 字符宽度0.9的字符数组
  const zeroPointNineLetters = ["z", "y", "x", "v", "c"];

  for (let letter of wordArr) {
    if (letter === "w" || letter === "m") {
      width += 1.5;
      continue;
    }
    if (letter === "s") {
      width += 0.8;
      continue;
    }
    if (letter === "t" || letter === "r" || letter === "f") {
      width += 0.7;
      continue;
    }
    if (letter === "j") {
      width += 0.6;
      continue;
    }
    if (letter === "i" || letter === "l" || letter === "'") {
      width += 0.5;
      continue;
    }

    // 记录是否已经增加宽度
    let increasedWidth = false;

    for (let key of onePointOneLetters) {
      if (key === letter) {
        width += 1.1;
        increasedWidth = true;
        break;
      }
    }

    for (let key of zeroPointNineLetters) {
      if (key === letter) {
        width += 0.9;
        increasedWidth = true;
        break;
      }
    }

    // 未增加宽度
    if (!increasedWidth) {
      width += 1;
    }
  }

  // 左右留白
  width += 1;

  return width;
}

function answerError() {
  let wrongTimes = 0;

  function handleAnswerError() {
    playErrorSound();
    wrongTimes++;
    if (wrongTimes >= 3) {
      showAnswerTip();
    }
  }

  return {
    handleAnswerError,
  };
}

const { handleAnswerError } = answerError();

function handleKeydown(e: KeyboardEvent) {
  if (e.code === "Enter") {
    e.stopPropagation();
    submitAnswer(
      () => {
        playRightSound(); // 正确提示
        showAnswer();
        hiddenAnswerTip();
      },
      handleAnswerError // 错误提示
    );

    return;
  }

  handleKeyboardInput(e, {
    useSpaceSubmitAnswer: {
      enable: isUseSpaceSubmitAnswer(),
      rightCallback: () => {
        playRightSound(); // 正确提示
        showAnswer();
      },
      errorCallback: handleAnswerError, // 错误提示
    },
  });
}

function useCursor() {
  function setInputCursorPosition(position: number) {
    inputEl.value?.setSelectionRange(position, position);
  }

  function getInputCursorPosition() {
    return inputEl.value?.selectionStart || 0;
  }

  function preventCursorMove(event: MouseEvent) {
    // 阻止 mousedown 事件的默认行为
    // 它会改变 input 光标的位置
    event.preventDefault();
    // 只允许 input focus
    handleInputFocus();
  }

  return {
    setInputCursorPosition,
    getInputCursorPosition,
    preventCursorMove,
  };
}

function useFocus() {
  const focusing = ref(true);

  onMounted(() => {
    handleInputFocus();
  });

  function handleInputFocus() {
    focusing.value = true;
    inputEl.value?.focus();
  }

  function handleBlur() {
    focusing.value = false;
  }

  return {
    focusing,
    handleInputFocus,
    handleBlur,
  };
}
</script>
